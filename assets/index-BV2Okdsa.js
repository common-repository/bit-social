import{r as N,u as H,c as W,a as u,j as a,L as I,F as j,i as X,k as $}from"./main-sixty-windows-relax.js";import{C as Y}from"./CronWarning-CxT7V9W3.js";import{D as U,R as Z}from"./Refresh-CXkExYDM.js";import{u as K,a as J,c as ee,k as te}from"./react-query-DTccfBeP.js";import{r as y,B as b,S as w,p as L,q as ae,u as E,M as se,o as T,v as le,F as Q,T as V,e as oe,P as ne,w as ce,n as re}from"./antd-Biwa_WcY.js";import{u as ie}from"./router-C23xx3cB.js";import{u as he}from"./useSchedules-CjI48kGm.js";import"./css-in-js-CSGOT-6T.js";globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};function ue(e,t){const n=K(),{mutateAsync:l,isPending:s}=J({mutationFn:async c=>N("logs/destroy/batch",{logIds:c},void 0,"POST"),onSuccess:()=>{n.invalidateQueries({queryKey:["logs",[t,e]]})}});return{deleteLogs:c=>l(c),isLogsDeleting:s}}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};function de(e,t,n){const{data:l,isLoading:s,isFetching:c,isFetched:d,refetch:i}=ee({queryKey:["logs",[e,t]],queryFn:async()=>N(`logs/${e}/${t}`,void 0,{...n},"GET"),enabled:!!t&&!!e,placeholderData:te,refetchInterval:3e3}),{data:h,pages:v,per_page:C,total:k,current_total:A,current_page:p}=(l==null?void 0:l.data)||{};return{logData:h||[],totalLogs:k,currentPage:p,totalPages:v,perPage:C,currentTotal:A,isLogsLoading:s,isFetching:c,isFetched:d,refetch:i}}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};function ge(){const e=K(),{data:t,mutateAsync:n,isPending:l}=J({mutationFn:async s=>N("retry",{...s},void 0,"POST"),onSuccess:()=>{e.invalidateQueries({queryKey:["logs"]})}});return{retry:s=>n(s),result:t,isRetryLoading:l}}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const pe=(e,t)=>{const n=Object.keys(e),l=Object.keys(t);return n.length!==l.length?!1:n.every(s=>e[s]===t[s])};function fe({filters:e,setFilters:t}){const[n,l]=y.useState(!1),[s,c]=y.useState(e),[d,i]=y.useState(),{schedules:h}=he(),{isProClient:v}=H(W),C=()=>{l(!0)},k=()=>{t({...s}),l(!1)},A=()=>{c(e),l(!1)},p=(r,x)=>{c(S=>({...S,[r]:x}))},D=[{label:"All",value:"all"},{label:"Facebook",value:"facebook"},{label:"Linkedin",value:"linkedin"}],R=[{label:"Google Business Profile",value:"googleBusinessProfile"},{label:"Pinterest",value:"pinterest"},{label:"Discord",value:"discord"},{label:"Tumblr",value:"tumblr"},{label:"X (twitter)",value:"twitter"}],O=v?[...D,...R]:D,P=h==null?void 0:h.map(r=>({label:r.name,value:String(r.id)})),f=[{label:"All",value:"all"},...P],F=r=>(x,S)=>{if(Array.isArray(S)&&S.every(z=>z===""))return p(r,"all");i(x),p(r,JSON.stringify(S))},M=()=>{i(void 0),c({...q})},_=pe(q,s)?"Ok":"Filter";return u(j,{children:[a(w,{children:a(b,{size:"large",onClick:C,icon:a(I,{name:"filter",size:12}),children:"Filter"})}),a(se,{maskClosable:!1,width:600,title:"Logs filter",open:n,onOk:k,onCancel:A,footer:[a(b,{onClick:M,children:"Reset"},"reset"),a(b,{type:"primary",onClick:k,children:_},"ok")],children:u(L,{layout:"vertical",children:[a(L.Item,{label:"Date",children:a(ae.RangePicker,{className:"w-100",value:d,onChange:F("date")})}),a(L.Item,{label:"Status",children:a(E,{defaultValue:"all",value:s.status,options:[{label:"All",value:"all"},{label:"Success",value:"1"},{label:"Error",value:"2"}],onChange:r=>p("status",r)})}),a(L.Item,{label:"Schedule",children:a(E,{defaultValue:"all",options:f,value:s.schedule,onChange:r=>p("schedule",r)})}),a(L.Item,{label:"Platform",children:a(E,{defaultValue:"all",value:s.platform,options:O,onChange:r=>p("platform",r)})})]})})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const B={1:"success",2:"error"};function me({filters:e}){const{status:t,platform:n,schedule:l}=e,s=e.date==="all"?!1:JSON.parse(e.date);return u(w,{size:"small",children:["Filter:",s&&u(T,{color:"purple",children:["Date: ",s[0]," to ",s[1]]}),t!=="all"&&u(T,{color:B[t],children:["Status: ",B[t]]}),l!=="all"&&u(T,{color:"orange",children:["Schedule: ",l," "]}),n!=="all"&&u(T,{color:"geekblue",children:["Platform: ",n]})]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};const ye=(e,t,n)=>{e.stopPropagation(),n(t)},{Paragraph:be,Text:Ce}=V,Se=(e,t)=>[{title:"Date",dataIndex:"date",key:"date",width:"15%"},{title:"Platform",dataIndex:"platform",key:"platform"},{title:"Account",dataIndex:"account",key:"account"},{title:"Schedule",dataIndex:"schedule",key:"schedule",width:"20%"},{title:"Response",dataIndex:"details",key:"details",width:"20%",render:(l,{status:s,details:c})=>{const i=JSON.stringify(c);return u(Q,{align:"center",children:[s==="1"?a(T,{color:"success",children:"Success"}):a(T,{color:"error",children:"Error"}),a(be,{style:{marginBottom:0},ellipsis:!0,copyable:{text:i},children:i})]})}},{title:"Actions",dataIndex:"actions",key:"actions",render:(l,{status:s,details:c,key:d,scheduleId:i})=>a(j,{children:s==="1"?a(b,{size:"small",target:"_blank",href:c==null?void 0:c.post_url,icon:a(I,{name:"external-link",size:13}),children:"Visit"}):a(b,{size:"small",disabled:t||!i,title:i?"Retry":"Related schedule was deleted",icon:a(I,{name:"repeat",size:13}),onClick:h=>ye(h,{details:c,key:d,scheduleId:i},e),danger:!0,children:"Retry"})})}],q={date:"all",status:"all",platform:"all",schedule:"all",scheduleId:"all"},ke=e=>a(re,{message:e.status==="1"?"Success":"Error",description:a("pre",{children:JSON.stringify(e.details,void 0,2)}),type:e.status==="1"?"success":"error",showIcon:!0}),Ae=({expanded:e,onExpand:t,record:n})=>a(b,{size:"small",onClick:l=>t(n,l),children:e?"Hide":"Details"}),Te={expandedRowRender:ke,expandIconAsCell:!0,expandIconColumnIndex:6,expandIcon:Ae};function we(){const[e,t]=ie({}),n=Number(e.get("page"))||1,l=Number(e.get("limit"))||10,[s,c]=y.useState([]),[d,i]=y.useState(q),{logData:h,totalLogs:v,totalPages:C,isLogsLoading:k,isFetching:A,refetch:p}=de(n,l,d),{deleteLogs:D,isLogsDeleting:R}=ue(l,n),{retry:O,isRetryLoading:P,result:f}=ge(),[F,M]=le.useMessage();y.useEffect(()=>{if(!P&&(f==null?void 0:f.status)==="success")return F.open({type:"success",content:"Retry call successfully"});if(!P&&(f==null?void 0:f.status)==="error")return F.open({type:"success",content:"Retry call successfully"})},[f]);const _=s.length>0,r=h&&(h==null?void 0:h.map(o=>{var m;return{key:o.id,date:X(o.created_at,`${$.DATE_FORMAT} ${$.TIME_FORMAT}`),schedule:((m=o==null?void 0:o.schedule)==null?void 0:m.name)||`Auto post - Post ID: ${o.details.post_id}`,account:o.details.account_name,platform:o.platform,details:o.details,status:o.status,scheduleId:o.schedule_id}})),x={onSelect:(o,m)=>{if(o){if(m){c(g=>[...g,o.key]);return}c(g=>g.filter(G=>G!==o.key))}},onSelectAll:(o,m)=>{if(o){c(m.map(g=>g==null?void 0:g.key).filter(g=>g!==void 0));return}c([])}},S=async()=>{await D(s),c([])},z=(o,m)=>{t(g=>(g.set("page",String(o)),g.set("limit",String(m)),g))};return y.useEffect(()=>{p(),c([])},[d]),y.useEffect(()=>{!h.length&&C&&n>C&&t(o=>(o.set("page",String(C)),o))},[h,d]),u(j,{children:[u(Q,{className:"mb-2",justify:"space-between",children:[u(w,{children:[(k||R)&&a(oe,{}),_?u(j,{children:[a(Ce,{children:`Selected ${s.length} items`}),a(ne,{title:"Delete Logs",description:"Are you sure to delete this logs?",onConfirm:S,okText:"Confirm",placement:"right",children:a(b,{icon:a(U,{}),type:"text",danger:!0})})]}):void 0,Object.values(d).every(o=>o==="all")?void 0:a(me,{filters:d,setFilters:i})]}),u(w,{children:[u(V.Link,{style:{fontSize:"18px"},rel:"noopener noreferrer",href:"https://bit-social.com/docs/log/",target:"_blank",strong:!0,children:["Visit our documentation"," ",a(I,{name:"move-up-right",style:{transform:"translateY(-2px)"}})]}),a(b,{size:"large",loading:A,icon:a(Z,{spin:A}),onClick:()=>p(),children:"Refresh"}),a(fe,{filters:d,setFilters:i})]})]}),a(Y,{}),a(ce,{className:"mt-1",rowSelection:x,expandable:Te,columns:Se(O,P),dataSource:r,bordered:!0,pagination:{showSizeChanger:!0,onChange:z,defaultCurrent:1,current:n,pageSize:l,total:v}}),M]})}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,t){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,t),t)}};export{we as default};
